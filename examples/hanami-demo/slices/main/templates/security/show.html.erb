<h2>Account Security</h2>

<div class="security-info">
  <p>Account ID: <strong><%= account_id %></strong></p>
</div>

<h3>Recent Account Activity</h3>

<p>Below are the last 50 authentication events on your account. If you notice any suspicious activity, please change your password immediately.</p>

<% if audit_logs && audit_logs.any? %>
  <div class="audit-log-table">
    <table>
      <thead>
        <tr>
          <th>Date & Time</th>
          <th>Event</th>
          <th>IP Address</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        <% audit_logs.each do |log| %>
          <tr>
            <td><%= log[:at].strftime("%Y-%m-%d %H:%M:%S") rescue log[:at] %></td>
            <td><%= log[:message] %></td>
            <td>
              <% if log[:metadata] %>
                <%
                  # Parse JSON metadata
                  metadata = log[:metadata].is_a?(String) ? JSON.parse(log[:metadata]) : log[:metadata] rescue {}
                %>
                <%= metadata["ip"] || metadata[:ip] || "Unknown" %>
              <% else %>
                Unknown
              <% end %>
            </td>
            <td>
              <% if metadata %>
                <small>
                  <% if metadata["user_agent"] || metadata[:user_agent] %>
                    <%= (metadata["user_agent"] || metadata[:user_agent])[0..60] %>
                  <% end %>
                  <% if metadata["request_path"] || metadata[:request_path] %>
                    <br><%= metadata["request_method"] || metadata[:request_method] %> <%= metadata["request_path"] || metadata[:request_path] %>
                  <% end %>
                </small>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% else %>
  <p>No recent activity found for your account.</p>
<% end %>

<h3>Security Actions</h3>
<div class="security-actions">
  <ul>
    <li><a href="/change-password">Change Password</a></li>
    <li><a href="/change-login">Change Email</a></li>
    <li><a href="/otp-setup">Setup Two-Factor Authentication (OTP)</a></li>
    <li><a href="/otp-disable">Disable Two-Factor Authentication</a></li>
    <li><a href="/recovery-codes">View Recovery Codes</a></li>
    <li><a href="/close-account">Close Account</a></li>
  </ul>
</div>

<p>
  <a href="/dashboard" class="button">Back to Dashboard</a>
</p>

<style>
  .security-info {
    background: #f0f8ff;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
  }

  .audit-log-table {
    overflow-x: auto;
    margin: 20px 0;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
  }

  th {
    background-color: #007bff;
    color: white;
    font-weight: bold;
  }

  tr:hover {
    background-color: #f5f5f5;
  }

  tr:last-child td {
    border-bottom: none;
  }

  .security-actions {
    background: #f9f9f9;
    padding: 20px;
    border-radius: 4px;
    margin-top: 30px;
  }

  .security-actions ul {
    list-style: none;
    padding: 0;
  }

  .security-actions li {
    margin: 10px 0;
  }

  .security-actions a {
    color: #007bff;
    text-decoration: none;
  }

  .security-actions a:hover {
    text-decoration: underline;
  }
</style>
