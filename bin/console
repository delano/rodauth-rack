#!/usr/bin/env ruby
# frozen_string_literal: true

require "bundler/setup"
require "sequel"
require "rodauth"
require "roda"
require "irb"

# Load rodauth-rack
require_relative "../lib/rodauth/tools"

puts "\n=== Rodauth::Tools Console ==="
puts "Utilities for Rodauth: table_guard feature + Sequel migration generator\n"

# Helper to create a test database with tables
def setup_test_db
  db = Sequel.sqlite

  # Create accounts table
  db.create_table :accounts do
    primary_key :id
    String :email, null: false, unique: true
    String :status, default: "unverified"
  end

  # Create password hash table
  db.create_table :account_password_hashes do
    foreign_key :id, :accounts, primary_key: true
    String :password_hash, null: false
  end

  puts "âœ“ Created test database with accounts and account_password_hashes tables"
  db
end

# Helper to create a Roda app with Rodauth
def create_app(db, features: [:login, :logout], table_guard_mode: nil)
  Class.new(Roda) do
    plugin :rodauth do
      self.db db
      enable(*features)
      enable :table_guard
      table_guard_mode(table_guard_mode) if table_guard_mode
    end

    route do |r|
      r.rodauth
      r.root { "Rodauth Test App" }
    end
  end
end

puts "\nAvailable helpers:"
puts "  setup_test_db                           # Create test SQLite DB"
puts "  create_app(db, features:, table_guard_mode:)  # Create Roda app"
puts "\nExample session:"
puts "  db = setup_test_db"
puts "  rodauth = create_app(db).rodauth"
puts "  rodauth.list_all_required_tables"
puts "  rodauth.table_status"
puts "  rodauth.missing_tables"
puts ""

IRB.start(__FILE__)
