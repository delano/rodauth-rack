<h1>Two-Factor Authentication (OTP/MFA)</h1>

<div class="otp-status">
  <% if @has_otp %>
    <div class="alert alert-success">
      <strong>Two-Factor Authentication is enabled</strong>
    </div>
  <% else %>
    <div class="alert alert-info">
      <strong>Two-Factor Authentication is not enabled</strong>
    </div>
  <% end %>
</div>

<h2>What is Two-Factor Authentication?</h2>
<p>
  Two-factor authentication (2FA) adds an extra layer of security to your account. After entering your password,
  you'll need to provide a time-based one-time password (TOTP) from an authenticator app like Google Authenticator,
  Authy, or 1Password.
</p>

<h2>How It Works</h2>
<ol>
  <li><strong>Setup</strong> - Generate a secret key and scan the QR code with your authenticator app</li>
  <li><strong>Verify</strong> - Enter a code from your app to confirm setup</li>
  <li><strong>Backup Codes</strong> - Save your recovery codes in a safe place</li>
  <li><strong>Login</strong> - After entering your password, you'll be prompted for a 6-digit code</li>
</ol>

<h2>Current Status</h2>
<ul>
  <li>OTP Enabled: <strong><%= @has_otp ? "Yes" : "No" %></strong></li>
  <li>Recovery Codes: <strong><%= @recovery_codes_count %> available</strong></li>
</ul>

<h2>Actions</h2>
<div class="otp-actions">
  <% if @has_otp %>
    <p>
      <%= link_to "Disable Two-Factor Auth", "/otp-disable", class: "btn btn-warning" %>
      <%= link_to "View Recovery Codes", "/recovery-codes", class: "btn btn-info" %>
    </p>
  <% else %>
    <p>
      <%= link_to "Setup Two-Factor Authentication", "/otp-setup", class: "btn btn-primary" %>
    </p>
  <% end %>
</div>

<h2>Important Security Notes</h2>
<div class="alert alert-warning">
  <ul>
    <li><strong>Save your recovery codes</strong> - If you lose access to your authenticator app, these codes are the only way to regain access to your account</li>
    <li><strong>Keep your secret secure</strong> - Never share your TOTP secret or QR code with anyone</li>
    <li><strong>Use a trusted authenticator</strong> - We recommend Google Authenticator, Authy, 1Password, or similar TOTP-compatible apps</li>
    <li><strong>Each code is single-use</strong> - Recovery codes can only be used once</li>
  </ul>
</div>

<h2>Example Flow</h2>
<p>Here's what happens when you set up OTP:</p>

<div class="flow-example">
  <pre>
1. Click "Setup Two-Factor Authentication"
2. You'll see a QR code and a secret key
3. Scan the QR code with your authenticator app
   (or manually enter the secret key)
4. Your app will start generating 6-digit codes
5. Enter one of these codes to verify setup
6. Save your recovery codes in a secure location
7. From now on, you'll need both your password
   and a code from your app to log in
  </pre>
</div>

<h2>JSON API Endpoints</h2>
<p>For SPA/mobile applications, these endpoints are available:</p>
<ul>
  <li><code>POST /otp-setup</code> - Initialize OTP setup, returns provisioning URI and QR code data</li>
  <li><code>POST /otp-auth</code> - Verify OTP code during login</li>
  <li><code>POST /otp-disable</code> - Disable OTP for account</li>
  <li><code>GET /recovery-codes</code> - View available recovery codes</li>
  <li><code>POST /recovery-auth</code> - Authenticate using a recovery code</li>
</ul>

<p>
  <%= link_to "Back to Home", "/", class: "btn btn-secondary" %>
  <%= link_to "View Security & Audit Log", "/account/security", class: "btn btn-info" %>
</p>

<style>
  .otp-status {
    margin-bottom: 20px;
  }

  .otp-actions {
    background: #f0f8ff;
    padding: 20px;
    border-radius: 4px;
    margin: 20px 0;
  }

  .flow-example {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 4px;
    margin: 20px 0;
  }

  .flow-example pre {
    margin: 0;
    font-family: monospace;
    line-height: 1.6;
  }

  code {
    background: #f5f5f5;
    padding: 2px 6px;
    border-radius: 3px;
    font-family: monospace;
  }
</style>
